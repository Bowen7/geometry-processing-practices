use crate::slice::*;
use faer::prelude::Solve;
use faer::sparse::linalg::solvers::*;
use faer::sparse::*;
use faer::Mat;
use faer::Side;
use web_sys::console;
use web_time::Instant;

pub struct MinQuadData {
  pub n: usize,
  llt: Option<Llt<usize, f32>>,
  lu: Option<Lu<usize, f32>>,
  known_indices: Vec<usize>,
  unknown_indices: Vec<usize>,
  preY: SparseColMat<usize, f32>,
}

pub fn min_quad_with_fixed_precompute(
  A: &SparseColMat<usize, f32>,
  known_indices: &[usize],
  is_pd: bool,
) -> MinQuadData {
  let A = 0.5 * A;
  let nrows = A.nrows();

  let mut fixed_mask = vec![false; nrows];

  for &index in known_indices {
    fixed_mask[index] = true;
  }

  let unknown_indices = (0..nrows).filter(|&i| !fixed_mask[i]).collect::<Vec<_>>();

  let Auk = slice(&A, &unknown_indices, &known_indices);
  let Aku = slice(&A, &known_indices, &unknown_indices);

  let Aku_t = Aku.transpose().to_col_major().unwrap();

  let Auu = slice(&A, &unknown_indices, &unknown_indices);

  let preY = Auk + Aku_t;

  let llt: Option<Llt<usize, f32>> = if is_pd {
    Some(Auu.sp_cholesky(Side::Lower).unwrap())
  } else {
    None
  };
  let lu: Option<Lu<usize, f32>> = if is_pd {
    None
  } else {
    Some(Auu.sp_lu().unwrap())
  };

  MinQuadData {
    llt,
    lu,
    preY,
    known_indices: known_indices.to_vec(),
    unknown_indices,
    n: nrows,
  }
}

pub fn min_quad_with_fixed_solve(
  data: &MinQuadData,
  B: &Mat<f32>,
  known_values: &Mat<f32>,
) -> Option<Mat<f32>> {
  let BBequlcols = Mat::from_fn(data.unknown_indices.len(), B.ncols(), |i, j| {
    B[(data.unknown_indices[i], j)]
  });

  let rhs = &data.preY * known_values + BBequlcols;

  let sol = if let Some(llt) = &data.llt {
    llt.solve(&rhs) * -0.5
  } else {
    data.lu.as_ref().unwrap().solve(&rhs) * -0.5
  };

  let mut Z: Mat<f32> = Mat::zeros(data.n, known_values.ncols());
  for i in 0..data.known_indices.len() {
    for j in 0..known_values.ncols() {
      Z[(data.known_indices[i], j)] = known_values[(i, j)];
    }
  }

  for i in 0..data.unknown_indices.len() {
    for j in 0..sol.ncols() {
      Z[(data.unknown_indices[i], j)] = sol[(i, j)];
    }
  }

  Some(Z)
}

pub fn min_quad_with_fixed(
  A: &SparseColMat<usize, f32>,
  B: &Mat<f32>,
  known_indices: &[usize],
  known_values: &Mat<f32>,
  is_pd: bool,
) -> Option<Mat<f32>> {
  let data = min_quad_with_fixed_precompute(A, known_indices, is_pd);
  min_quad_with_fixed_solve(&data, B, known_values)
}

#[cfg(test)]
mod tests {
  use super::*;
  use approx::assert_relative_eq;
  use faer::prelude::*;

  #[test]
  fn test_min_quad_with_fixed_1() {
    let I = vec![0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4];
    let J = vec![0, 1, 0, 1, 2, 1, 2, 3, 2, 3, 4, 3, 4];
    let V = vec![
      2.0, -1.0, -1.0, 2.0, -1.0, -1.0, 2.0, -1.0, -1.0, 2.0, -1.0, -1.0, 2.0,
    ];

    let mut triplets: Vec<Triplet<usize, usize, f32>> = vec![];
    for i in 0..I.len() {
      triplets.push(Triplet::new(I[i], J[i], V[i]));
    }
    let A = SparseColMat::<usize, f32>::try_new_from_triplets(5, 5, &triplets).unwrap();

    let B = mat![[0.0], [0.5], [0.0], [-0.5], [0.0]];

    let known_indices = vec![0, 4];

    let known_values = mat![[0.0], [10.0]];

    let Z = min_quad_with_fixed(&A, &B, &known_indices, &known_values, false);
    let out = mat![[0.0], [2.25], [5.0], [7.75], [10.0]];
    if let Some(Z) = Z {
      for i in 0..Z.nrows() {
        for j in 0..Z.ncols() {
          assert_relative_eq!(Z[(i, j)], out[(i, j)], epsilon = 0.01);
        }
      }
    } else {
      println!("No solution");
    }
  }

  #[test]
  fn test_min_quad_with_fixed_3() {
    let I = vec![0, 0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4];
    let J = vec![0, 1, 0, 1, 2, 1, 2, 3, 2, 3, 4, 3, 4];
    let V = vec![
      2.0, -1.0, -1.0, 2.0, -1.0, -1.0, 2.0, -1.0, -1.0, 2.0, -1.0, -1.0, 2.0,
    ];

    let mut triplets: Vec<Triplet<usize, usize, f32>> = vec![];
    for i in 0..I.len() {
      triplets.push(Triplet::new(I[i], J[i], V[i]));
    }
    let A = SparseColMat::<usize, f32>::try_new_from_triplets(5, 5, &triplets).unwrap();

    let B = mat![
      [0.0, 0.0, 0.0],
      [1.0, 0.0, 0.0],
      [0.0, 1.0, 0.0],
      [0.0, 0.0, 1.0],
      [0.0, 0.0, 0.0]
    ];

    let known_indices = vec![0, 4];

    let known_values = mat![[0.0, 0.0, 0.0], [10.0, 10.0, 10.0]];

    let Z = min_quad_with_fixed(&A, &B, &known_indices, &known_values, true);
    let out = mat![
      [0.0, 0.0, 0.0],
      [1.75, 2.0, 2.25],
      [4.5, 4.0, 4.5],
      [7.25, 7.0, 6.75],
      [10.0, 10.0, 10.0],
    ];
    if let Some(Z) = Z {
      for i in 0..Z.nrows() {
        for j in 0..Z.ncols() {
          assert_relative_eq!(Z[(i, j)], out[(i, j)], epsilon = 0.01);
        }
      }
    } else {
      println!("No solution");
    }

    let t1 = mat![
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [101.625946],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [427.39648],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [-649.0973],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [629.387],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [-3210.018],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [-5779.6436],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [792.569],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [-1458.1945],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [1109.2432],
      [0.0],
      [-9176.227],
      [744.8568],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [710.7598],
      [-7057.2344],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [426.93555],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [815.66614],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [256.65955],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [754.60596],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [20.809511],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
    ];

    let t2 = mat![[0.7726472, 0.478346, 0.48362],];

    let t3 = mat![
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
      [0.0],
    ];
    let x = t1 * t2 + t3;
  }
}
